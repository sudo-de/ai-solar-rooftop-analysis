name: Build and Push Docker Images

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      push_to_registry:
        description: 'Push images to Docker Hub'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  REGISTRY: docker.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          image=moby/buildkit:latest
          network=host

    - name: Clean up Docker build cache
      if: always()
      run: |
        docker builder prune -af --filter "until=24h" || true
        docker system prune -af --volumes --filter "until=24h" || true

    - name: Check Docker credentials
      id: docker-creds
      run: |
        if [ -n "${{ secrets.DOCKER_USERNAME }}" ] && [ -n "${{ secrets.DOCKER_PASSWORD }}" ]; then
          echo "has_creds=true" >> $GITHUB_OUTPUT
        else
          echo "has_creds=false" >> $GITHUB_OUTPUT
        fi

    - name: Log in to Docker Hub
      if: github.event_name != 'pull_request' && (github.event.inputs.push_to_registry == 'true' || github.event.inputs.push_to_registry == '') && steps.docker-creds.outputs.has_creds == 'true'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        logout: false
      continue-on-error: true

    - name: Determine image tags
      id: tags
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      run: |
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          if [ -n "$DOCKER_USERNAME" ]; then
            echo "frontend_tag=${DOCKER_USERNAME}/ai-solar-frontend:latest" >> $GITHUB_OUTPUT
            echo "backend_tag=${DOCKER_USERNAME}/ai-solar-backend:latest" >> $GITHUB_OUTPUT
          else
            echo "frontend_tag=ai-solar-frontend:latest" >> $GITHUB_OUTPUT
            echo "backend_tag=ai-solar-backend:latest" >> $GITHUB_OUTPUT
          fi
        else
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          if [ -n "$DOCKER_USERNAME" ]; then
            echo "frontend_tag=${DOCKER_USERNAME}/ai-solar-frontend:${BRANCH_NAME}-${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "backend_tag=${DOCKER_USERNAME}/ai-solar-backend:${BRANCH_NAME}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          else
            echo "frontend_tag=ai-solar-frontend:${BRANCH_NAME}-${SHORT_SHA}" >> $GITHUB_OUTPUT
            echo "backend_tag=ai-solar-backend:${BRANCH_NAME}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          fi
        fi
        echo "frontend_test_tag=ai-solar-frontend:test" >> $GITHUB_OUTPUT
        echo "backend_test_tag=ai-solar-backend:test" >> $GITHUB_OUTPUT

    - name: Build frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: false
        tags: ${{ steps.tags.outputs.frontend_test_tag }}
        cache-from: type=gha
        cache-to: type=gha,mode=min

    - name: Push frontend image to Docker Hub
      if: github.event_name != 'pull_request' && (github.event.inputs.push_to_registry == 'true' || github.event.inputs.push_to_registry == '') && steps.docker-creds.outputs.has_creds == 'true'
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: true
        tags: ${{ steps.tags.outputs.frontend_tag }}
        cache-from: type=gha
        cache-to: type=gha,mode=min
      continue-on-error: true

    - name: Clean up after frontend build
      if: always()
      run: |
        docker builder prune -f --filter "until=1h" || true
        rm -rf /tmp/frontend-image.tar 2>/dev/null || true

    - name: Build backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: false
        tags: ${{ steps.tags.outputs.backend_test_tag }}
        cache-from: type=gha
        cache-to: type=gha,mode=min

    - name: Push backend image to Docker Hub
      if: github.event_name != 'pull_request' && (github.event.inputs.push_to_registry == 'true' || github.event.inputs.push_to_registry == '') && steps.docker-creds.outputs.has_creds == 'true'
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: true
        tags: ${{ steps.tags.outputs.backend_tag }}
        cache-from: type=gha
        cache-to: type=gha,mode=min
      continue-on-error: true

    - name: Clean up after backend build
      if: always()
      run: |
        docker builder prune -f --filter "until=1h" || true
        rm -rf /tmp/backend-image.tar 2>/dev/null || true

    - name: Final cleanup
      if: always()
      run: |
        docker system df
        docker builder prune -af --filter "until=1h" || true
        df -h

    - name: Image summary
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      run: |
        echo "## Docker Images Built" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Frontend" >> $GITHUB_STEP_SUMMARY
        echo "- Test tag: \`${{ steps.tags.outputs.frontend_test_tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Production tag: \`${{ steps.tags.outputs.frontend_tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Backend" >> $GITHUB_STEP_SUMMARY
        echo "- Test tag: \`${{ steps.tags.outputs.backend_test_tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Production tag: \`${{ steps.tags.outputs.backend_tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -z "$DOCKER_USERNAME" ]; then
          echo "⚠️ **Docker credentials not configured. Images built but not pushed.**" >> $GITHUB_STEP_SUMMARY
        else
          echo "✅ **Images pushed to Docker Hub**" >> $GITHUB_STEP_SUMMARY
        fi
