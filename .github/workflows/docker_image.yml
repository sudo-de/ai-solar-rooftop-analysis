name: Build and Push Backend Docker Image

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      push_to_registry:
        description: 'Push images to Docker Hub'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  REGISTRY: docker.io

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: docker
    permissions:
      contents: read
      packages: write

    steps:
    - name: Free disk space
      run: |
        echo "Disk space before cleanup:"
        df -h
        # Remove unnecessary packages and files
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        # Clean up apt cache
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        # Clean up Docker
        docker system prune -af --volumes || true
        docker builder prune -af || true
        echo "Disk space after cleanup:"
        df -h

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          image=moby/buildkit:latest
          network=host

    - name: Check Docker credentials
      id: docker-creds
      run: |
        if [ -n "${{ secrets.DOCKER_USERNAME }}" ] && [ -n "${{ secrets.DOCKER_PASSWORD }}" ]; then
          echo "has_creds=true" >> $GITHUB_OUTPUT
          echo "âœ… Docker credentials found"
        else
          echo "has_creds=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Docker credentials not found in secrets"
          echo "Please set DOCKER_USERNAME and DOCKER_PASSWORD as environment secrets in the 'docker' environment"
        fi

    - name: Log in to Docker Hub
      if: github.event_name != 'pull_request' && (github.event.inputs.push_to_registry == 'true' || github.event.inputs.push_to_registry == '') && steps.docker-creds.outputs.has_creds == 'true'
      uses: docker/login-action@v3
      with:
        registry: docker.io
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        logout: false

    - name: Verify Docker Hub login
      if: github.event_name != 'pull_request' && (github.event.inputs.push_to_registry == 'true' || github.event.inputs.push_to_registry == '') && steps.docker-creds.outputs.has_creds == 'true'
      run: |
        echo "Verifying Docker Hub login..."
        docker info | grep -i "username" || echo "âš ï¸ Could not verify login"
        echo "âœ… Docker Hub login verified"

    - name: Determine image tags
      id: tags
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      run: |
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          if [ -n "$DOCKER_USERNAME" ]; then
            echo "backend_tag=${DOCKER_USERNAME}/ai-solar-backend:latest" >> $GITHUB_OUTPUT
          else
            echo "backend_tag=ai-solar-backend:latest" >> $GITHUB_OUTPUT
          fi
        else
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          if [ -n "$DOCKER_USERNAME" ]; then
            echo "backend_tag=${DOCKER_USERNAME}/ai-solar-backend:${BRANCH_NAME}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          else
            echo "backend_tag=ai-solar-backend:${BRANCH_NAME}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          fi
        fi
        echo "backend_test_tag=ai-solar-backend:test" >> $GITHUB_OUTPUT

    - name: Build backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: false
        tags: ${{ steps.tags.outputs.backend_test_tag }}
        cache-from: type=gha
        # Don't export cache to save disk space

    - name: Clean up after build
      if: always()
      run: |
        docker builder prune -af || true
        docker image prune -af || true
        rm -rf /tmp/* 2>/dev/null || true
        echo "Disk space after build:"
        df -h

    - name: Push backend image to Docker Hub
      if: github.event_name != 'pull_request' && (github.event.inputs.push_to_registry == 'true' || github.event.inputs.push_to_registry == '') && steps.docker-creds.outputs.has_creds == 'true'
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: true
        tags: ${{ steps.tags.outputs.backend_tag }}
        cache-from: type=gha
        # Don't export cache to save disk space

    - name: Final cleanup
      if: always()
      run: |
        docker system prune -af --volumes || true
        docker builder prune -af || true
        docker image prune -af || true
        rm -rf /tmp/* 2>/dev/null || true
        echo "Final disk space:"
        df -h

    - name: Image summary
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      run: |
        echo "## Docker Image Built" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Backend" >> $GITHUB_STEP_SUMMARY
        echo "- Test tag: \`${{ steps.tags.outputs.backend_test_tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Production tag: \`${{ steps.tags.outputs.backend_tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -z "$DOCKER_USERNAME" ]; then
          echo "âš ï¸ **Docker credentials not configured. Image built but not pushed.**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To enable pushing to Docker Hub:" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to GitHub repository Settings â†’ Secrets and variables â†’ Actions â†’ Environments â†’ docker" >> $GITHUB_STEP_SUMMARY
          echo "2. Add environment secrets: \`DOCKER_USERNAME\` and \`DOCKER_PASSWORD\`" >> $GITHUB_STEP_SUMMARY
          echo "3. For Docker Hub, use an Access Token (not password) from https://hub.docker.com/settings/security" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **Image pushed to Docker Hub**" >> $GITHUB_STEP_SUMMARY
        fi

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
    environment: docker
    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to production
      run: |
        echo "ðŸš€ Deploying Docker image to production..."
        echo ""
        echo "### Deployment Information" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Backend Image:** \`${{ secrets.DOCKER_USERNAME }}/ai-solar-backend:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment Commands" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# Pull latest backend image" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ${{ secrets.DOCKER_USERNAME }}/ai-solar-backend:latest" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Deploy with docker-compose" >> $GITHUB_STEP_SUMMARY
        echo "docker-compose pull backend" >> $GITHUB_STEP_SUMMARY
        echo "docker-compose up -d backend" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Image is ready for deployment**" >> $GITHUB_STEP_SUMMARY
        echo ""
        echo "âœ… Deployment information generated"
        echo "ðŸ“¦ Backend image is available on Docker Hub"
        echo "ðŸ”— Pull and deploy using the commands above"
